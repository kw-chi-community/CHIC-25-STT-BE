name: Build and Deploy Docker Compose

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SSH and sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-client sshpass

    # 1️⃣ 서버로 `docker-compose.yml`을 전송
    - name: Transfer Docker Compose file to temporary location
      run: |
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no \
          docker-compose.yml ${{ secrets.SSH_ID }}@${{ secrets.SSH_SERVER_IP }}:/tmp/docker-compose.yml

    # 2️⃣ `/home/ubuntu/docker-compose.yml`로 이동 (또는 원하는 경로 설정)
    - name: Move Docker Compose file with sudo
      run: |
        sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_ID }}@${{ secrets.SSH_SERVER_IP }} << EOF
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S mv /tmp/docker-compose.yml /home/ubuntu/chic_stt/docker-compose.yml
        EOF

    # 3️⃣ 서버에서 `docker-compose pull`, `docker-compose up -d` 실행
    - name: Deploy with Docker Compose
      run: |
        sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_ID }}@${{ secrets.SSH_SERVER_IP }} << EOF
          echo "Pulling latest Docker images..."
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S docker-compose -f /home/ubuntu/chic_stt/docker-compose.yml pull

          echo "Stopping existing services..."
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S docker-compose -f /home/ubuntu/chic_stt/docker-compose.yml down || true

          echo "Starting new services..."
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S docker-compose -f /home/ubuntu/chic_stt/docker-compose.yml up -d --env-file /home/ubuntu/.env

          echo "Cleaning up unused Docker images..."
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S docker system prune -af
        EOF
