name: Build and Deploy Docker Compose

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
        docker-compose version

    - name: Log in to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

    - name: Build images using docker-compose
      run: |
        docker-compose build  # âœ… ì´ì œ .env ì—†ì´ ë¹Œë“œ ê°€ëŠ¥

    - name: List Docker images (ë””ë²„ê¹…ìš©)
      run: |
        echo "ðŸ” í˜„ìž¬ ì¡´ìž¬í•˜ëŠ” Docker ì´ë¯¸ì§€:"
        docker images

    - name: Tag and push FastAPI image
      run: |
        docker tag fastapi_app ${{ secrets.DOCKER_HUB_USERNAME }}/fastapi_app:latest
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/fastapi_app:latest

    - name: Tag and push Celery worker image
      run: |
        docker tag celery_worker ${{ secrets.DOCKER_HUB_USERNAME }}/celery_worker:latest
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/celery_worker:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    - name: Install SSH client
      run: sudo apt-get update && sudo apt-get install -y openssh-client

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Deploy to Server
      run: |
        ssh ${{ secrets.SSH_ID }}@${{ secrets.SSH_SERVER_IP }} << 'EOF'
          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "Pulling latest Docker images..."
          docker-compose pull

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          echo "Stopping existing services..."
          docker-compose down

          # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì´ì œ env_file ì ìš©)
          echo "Starting new services..."
          docker-compose up -d --env-file /home/ubuntu/.env

          # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ë° ìºì‹œ ì‚­ì œ
          echo "Cleaning up unused Docker images..."
          docker system prune -af
        EOF
